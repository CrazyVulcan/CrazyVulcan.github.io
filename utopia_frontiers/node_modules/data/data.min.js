(function(){var f;f=typeof exports!=="undefined"?exports:this.Data={};f.VERSION="0.6.1";var d=this._;if(!d&&typeof require!=="undefined")d=require("underscore");f.VALUE_TYPES=["string","object","number","boolean","date"];f.isValueType=function(a){return d.include(f.VALUE_TYPES,d.last(a))};f.uuid=function(a){for(var b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),c=[],e=0;e<32;e++)c[e]=b[0|Math.random()*16];return(a?a:"")+c.join("")};var m=/\s+/;d.Events={on:function(a,b,c){var e,g,h,i,j;if(!b)return this;
a=a.split(m);for(e=this._callbacks||(this._callbacks={});g=a.shift();){h=(j=e[g])?j.tail:{};h.next=i={};h.context=c;h.callback=b;e[g]={tail:i,next:j?j.next:h}}return this},off:function(a,b,c){var e,g,h,i,j,k;if(g=this._callbacks){if(!(a||b||c)){delete this._callbacks;return this}for(a=a?a.split(m):d.keys(g);e=a.shift();){h=g[e];delete g[e];if(h&&(b||c))for(i=h.tail;(h=h.next)!==i;){j=h.callback;k=h.context;if(b&&j!==b||c&&k!==c)this.on(e,j,k)}}return this}},trigger:function(a){var b,c,e,g,h,i;if(!(e=
this._callbacks))return this;h=e.all;a=a.split(m);for(i=slice.call(arguments,1);b=a.shift();){if(c=e[b])for(g=c.tail;(c=c.next)!==g;)c.callback.apply(c.context||this,i);if(c=h){g=c.tail;for(b=[b].concat(i);(c=c.next)!==g;)c.callback.apply(c.context||this,b)}}return this}};d.Events.bind=d.Events.on;d.Events.unbind=d.Events.off;f.Query={query:function(a){function b(g,h){var i=true;d.find(h,function(j,k){var l=k==="type"?g.types:g.properties[k];if(k==="_id")l=g._id;if(d.intersect(d.isArray(j)?j:[j],
d.isArray(l)?l:[l]).length===0){i=false;return true}});return i}var c=this.get(a.type),e=d.select(this.objects,function(g){return b(g,a)});return f.Collection.create(c,e)}};f.Type=function(a){this._id=a._id;this.type="/type/type";this.name=a.name;this.meta=a.meta||{};this.indexes=a.indexes||{};this.properties=a.properties;d.each(this.properties,d.bind(function(b){b.type=d.isArray(b.type)?b.type:[b.type];b.unique=d.isBoolean(b.unique)?b.unique:true},this))};d.extend(f.Type.prototype,d.Events,{toJSON:function(){return{_id:this._id,
type:"/type/type",properties:this.properties,meta:this.meta,indexes:d.map(this.indexes,function(a){return a.properties})}}});f.Object=function(a,b){this._id=a._id;this.host=b;this.properties={};this.set(a)};d.extend(f.Object.prototype,d.Events,{type:function(){return this.host.get(d.last(this.types))},property:function(a){var b=null;d.find(d.clone(this.types).reverse(),d.bind(function(c){return b=this.host.get(c).properties[a]},this));return b},get:function(a){var b=this.property(a);a=this.properties[a];
if(!b||a===undefined)return null;return f.isValueType(b.type)?a:b.unique?this.host.get(a):d.map(a,d.bind(function(c){return this.host.get(c)},this))},set:function(a){var b=this;if(a.type)this.types=d.isArray(a.type)?a.type:[a.type];if(a.meta)this.meta=this.object.meta;d.each(a,d.bind(function(c,e){!b.property(e)||e==="type"||(b.properties[e]=c)},this))},toJSON:function(){return d.extend(this.properties,{_id:this._id,type:this.types})}});f.Graph=function(a){this.nodes=[];this.objects=[];this.types=
[];this.keys={};a&&this.merge(a)};d.extend(f.Graph.prototype,f.Query,d.Events,{merge:function(a){d.each(a,d.bind(function(b,c){this.set(d.extend(b,{_id:c}))},this));return this},get:function(a){return this.nodes[this.keys[a]]},set:function(a){function b(){return d.last(c)==="/type/type"?new f.Type(a):new f.Object(a,this)}var c=d.isArray(a.type)?a.type:[a.type];a._id=a._id?a._id:f.uuid("/"+d.last(d.last(c).split("/"))+"/");var e=this.get(a._id);if(e)e.set(a);else{e=b.apply(this);this.keys[a._id]=this.nodes.length;
this.nodes.push(e);d.last(c)==="/type/type"?this.types.push(e):this.objects.push(e)}return e},find:function(a){return this.query(a)},del:function(a){if(a=this.get(a))a._deleted=true},toJSON:function(){var a={};d.each(this.nodes,function(b){a[b._id]=b.toJSON()});return a}});f.Collection=function(a){this.type=new f.Type(a.type,this);this.objects=[];this.length=0;this.keys={};d.each(a.objects,d.bind(function(b){this.add(b)},this))};f.Collection.create=function(a,b){var c=new f.Collection({type:a,objects:[]});
c.objects=b;c.length=b.length;d.each(b,function(e,g){c.keys[e._id]=g});return c};d.extend(f.Collection.prototype,d.Events,f.Query,{get:function(a){if(a.match("^/type/"))return this.type;return this.objects[this.keys[a]]},at:function(a){return this.objects[a]},index:function(a){return this.keys[a]},key:function(a){return this.objects[a]._id},add:function(a){var b;if(a instanceof f.Object){b=a;this.keys[b._id]=this.objects.length;this.objects.push(b);this.length=this.objects.length}else{a._id=a._id?
a._id:f.uuid("/"+d.last(this.type._id.split("/"))+"/");a.type=this.type._id;if(b=this.get(a._id))b.set(a);else{b=new f.Object(a,this);this.keys[b._id]=this.objects.length;this.objects.push(b);this.length=this.objects.length}}return b},find:function(a){a.type=this.type._id;return this.query(a)},each:function(a){d.each(this.objects,function(b,c){a.call(this,b,b._id,c)},this);return this},first:function(){return this.length>0?this.objects[0]:null},last:function(){return this.length>0?this.objects[this.length-
1]:null},range:function(a,b){for(var c=f.Collection.create(this.type,[]),e=a;e<=b&&e<this.objects.length;e++)c.add(this.at(e));return c},intersect:function(a){var b=new f.Collection.create(this.type,[]),c,e;if(a.length<this.length){c=a;e=this}else{c=this;e=a}d.each(c.objects,function(g){e.get(g._id)&&b.add(a.get(g._id))});return b},union:function(a){var b=new f.Collection.create(this.type,[]);this.each(function(c){b.add(c)});a.each(function(c,e){b.get(e)||b.add(c)});return b},difference:function(a){result=
new f.Collection.create(this.type,[]);this.each(function(b,c){a.get(c)||result.add(b)});return result},toJSON:function(){return{type:this.type.toJSON(),objects:d.map(this.objects,function(a){return a.toJSON()})}}})})();
